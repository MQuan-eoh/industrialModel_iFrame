<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3">
          <div class="card">
            <h3>OEE</h3>
            <div class="gauge">
              <span> 56.6% </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <h3>Performance</h3>
            <div class="gauge">
              <span> 72.6% </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <h3>Quality</h3>
            <div class="gauge">
              <span> 80.0% </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <h3>Availability</h3>
            <div class="gauge">
              <span> 97.4% </span>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <h3>Machine state</h3>
            <p>machineinfo_machinestate_state_machinemode</p>
            <div class="timeline">
              <div>09:48:30</div>
              <div>09:49:00</div>
              <div>09:49:30</div>
              <div>09:50:00</div>
              <div>09:50:30</div>
              <div>09:51:00</div>
              <div>09:51:30</div>
              <div>09:52:00</div>
              <div>09:52:30</div>
              <div>09:53:00</div>
            </div>
            <div class="timeline status">
              <div class="ai">AI</div>
              <div class="running">Running</div>
              <div class="stopped">Stopped</div>
              <div class="running">Running</div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <h3>Production quality</h3>
            <div class="chart">
              <img
                alt="Pie chart showing production quality with good and bad parts"
                height="200"
                src="https://storage.googleapis.com/a1aa/image/OenIV5Vfpa74Dy6ggMOgv-UQfzTHTzJzeP-vSzcjqZU.jpg"
                width="200"
              />
            </div>
            <p>good_parts</p>
            <p>bad_parts</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <h3>GUID Running order</h3>
            <p>966e582b-02a6-4fdd-88bb-d908674b6c05</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <h3>Product weight</h3>
            <div class="chart">
              <img
                alt="Bar chart showing product weight distribution"
                height="200"
                src="https://storage.googleapis.com/a1aa/image/llu3iuIebmv1SFSH_P0c3OqYzTi_kYRNAnSCNghiFKs.jpg"
                width="200"
              />
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <h3>Product group</h3>
            <p>Black</p>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card">
            <h3>Pick &amp; place</h3>
            <script>
              let scene, camera, renderer, controls;
              const originalMaterials = new Map();

              function init() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xcccccc);

                camera = new THREE.PerspectiveCamera(
                  75,
                  window.innerWidth / window.innerHeight,
                  0.1,
                  1000
                );
                camera.position.set(0, 1, 3);

                // Cải thiện renderer với tone mapping và gamma correction
                renderer = new THREE.WebGLRenderer({
                  antialias: true,
                  preserveDrawingBuffer: true,
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.0;
                renderer.outputEncoding = THREE.sRGBEncoding;
                renderer.gammaFactor = 2.2;
                renderer.gammaOutput = true;
                document.body.appendChild(renderer.domElement); 

                controls = new THREE.OrbitControls(camera, renderer.domElement);

                // Cải thiện hệ thống ánh sáng
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);

                const directionalLight1 = new THREE.DirectionalLight(
                  0xffffff,
                  1
                );
                directionalLight1.position.set(5, 10, 7);
                scene.add(directionalLight1);

                // Thêm ánh sáng phụ để cân bằng
                const directionalLight2 = new THREE.DirectionalLight(
                  0xffffff,
                  0.5
                );
                directionalLight2.position.set(-5, -5, -5);
                scene.add(directionalLight2);

                const hemisphereLight = new THREE.HemisphereLight(
                  0xffffff,
                  0x444444,
                  0.5
                );
                scene.add(hemisphereLight);

                scene.add(new THREE.AxesHelper(2));

                const loader = new THREE.GLTFLoader();
                loader.load(
                  "assets/3DComponents/test_factory_line_fur__cas.glb", //Một dây chuyền sản xuất
                  function (gltf) {
                    const model = gltf.scene;
                    scene.add(model);

                    // Điều chỉnh materials
                    model.traverse((child) => {
                      if (child.isMesh) {
                        if (Array.isArray(child.material)) {
                          child.material.forEach((material) => {
                            material.encoding = THREE.sRGBEncoding;
                            if (material.map)
                              material.map.encoding = THREE.sRGBEncoding;
                          });
                          originalMaterials.set(
                            child.uuid,
                            child.material.map((m) => m.clone())
                          );
                        } else {
                          child.material.encoding = THREE.sRGBEncoding;
                          if (child.material.map)
                            child.material.map.encoding = THREE.sRGBEncoding;
                          originalMaterials.set(
                            child.uuid,
                            child.material.clone()
                          );
                        }
                        // Bật shadows nếu cần
                        child.castShadow = true;
                        child.receiveShadow = true;
                      }
                    });

                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    model.position.x -= center.x;
                    model.position.y -= center.y;
                    model.position.z -= center.z;

                    const maxDim = Math.max(size.x, size.y, size.z);
                    camera.position.set(0, maxDim, maxDim * 2);
                    camera.lookAt(0, 0, 0);
                  },
                  undefined,
                  function (error) {
                    console.error("Lỗi khi load model:", error);
                  }
                );
              }

              function restoreOriginalMaterials() {
                scene.traverse((child) => {
                  if (child.isMesh && originalMaterials.has(child.uuid)) {
                    const originalMaterial = originalMaterials.get(child.uuid);
                    if (Array.isArray(originalMaterial)) {
                      child.material = originalMaterial.map((m) => m.clone());
                    } else {
                      child.material = originalMaterial.clone();
                    }
                  }
                });
              }

              function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
              }

              window.addEventListener("resize", () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
              });

              window.addEventListener("keydown", (event) => {
                if (event.key === "r" || event.key === "R") {
                  restoreOriginalMaterials();
                }
              });

              init();
              animate();
            </script>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
